@page "/review"
@attribute [Authorize]

<PageTitle>Review Queue - OrderPulse</PageTitle>

<h2 style="margin-bottom:1.5rem;font-size:1.5rem;font-weight:700;">Review Queue</h2>

@if (_selectedItem is not null && _detail is not null)
{
    <!-- Detail: side-by-side view -->
    <button class="btn btn-secondary" style="margin-bottom:1rem;" @onclick="CloseDetail">
        &#x2190; Back to Queue
    </button>

    <div class="review-header">
        <div>
            <span class="text-muted">From:</span>
            <strong>@(_detail.FromDisplayName ?? _detail.FromAddress)</strong>
            @if (_detail.FromDisplayName is not null)
            {
                <span class="text-muted" style="margin-left:0.5rem;">&lt;@_detail.FromAddress&gt;</span>
            }
        </div>
        <div>
            <span class="text-muted">Subject:</span> @_detail.Subject
        </div>
        <div>
            <span class="text-muted">Received:</span> @_detail.ReceivedAt.ToString("MMM d, yyyy h:mm tt")
            <span style="margin-left:1rem;" class="text-muted">Classification:</span>
            <span class="badge badge-blue">@FormatClassification(_detail.ClassificationType)</span>
            @if (_detail.ClassificationConfidence.HasValue)
            {
                <span class="text-muted" style="margin-left:0.5rem;">
                    (@(_detail.ClassificationConfidence.Value * 100):F0% confidence)
                </span>
            }
        </div>
        @if (!string.IsNullOrEmpty(_detail.ErrorDetails))
        {
            <div class="review-error">@_detail.ErrorDetails</div>
        }
    </div>

    <div class="review-split">
        <!-- Left: Original Email -->
        <div class="review-panel">
            <h3 class="review-panel-title">Original Email</h3>
            <div class="review-panel-body">
                @if (!string.IsNullOrEmpty(_detail.BodyHtml))
                {
                    <iframe srcdoc="@_detail.BodyHtml" class="email-frame" sandbox="allow-same-origin"></iframe>
                }
                else
                {
                    <div class="text-muted" style="white-space:pre-wrap;">@(_detail.BodyPreview ?? "No email body available.")</div>
                }
            </div>
        </div>

        <!-- Right: AI Parsed Output + Corrections -->
        <div class="review-panel">
            <h3 class="review-panel-title">AI Parsed Output</h3>
            <div class="review-panel-body">
                <div class="review-field">
                    <label>Classification Type</label>
                    <select @bind="_corrections.CorrectedClassificationType">
                        <option value="">@FormatClassification(_detail.ClassificationType)</option>
                        @foreach (var ct in _classificationTypes)
                        {
                            <option value="@ct">@FormatClassification(ct)</option>
                        }
                    </select>
                </div>
                <div class="review-field">
                    <label>Order Number</label>
                    <input type="text" @bind="_corrections.CorrectedOrderNumber"
                           placeholder="@(_detail.ParsedOrderNumber ?? "Not parsed")" />
                </div>
                <div class="review-field">
                    <label>Retailer</label>
                    <input type="text" @bind="_corrections.CorrectedRetailer"
                           placeholder="@(_detail.ParsedRetailer ?? "Not parsed")" />
                </div>
                <div class="review-field">
                    <label>Amount</label>
                    <input type="number" step="0.01" @bind="_corrections.CorrectedAmount"
                           placeholder="@(_detail.ParsedAmount?.ToString("F2") ?? "Not parsed")" />
                </div>
                <div class="review-field">
                    <label>Tracking Number</label>
                    <input type="text" @bind="_corrections.CorrectedTrackingNumber"
                           placeholder="@(_detail.ParsedTrackingNumber ?? "Not parsed")" />
                </div>
                <div class="review-field">
                    <label>Carrier</label>
                    <input type="text" @bind="_corrections.CorrectedCarrier"
                           placeholder="@(_detail.ParsedCarrier ?? "Not parsed")" />
                </div>

                @if (!string.IsNullOrEmpty(_detail.ParsedRawJson))
                {
                    <details style="margin-top:1rem;">
                        <summary class="text-muted" style="cursor:pointer;">Raw JSON</summary>
                        <pre class="raw-json">@_detail.ParsedRawJson</pre>
                    </details>
                }
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="review-actions">
        <button class="btn btn-primary" @onclick="HandleApprove" disabled="@_saving">
            @(_saving ? "Saving..." : "Approve")
        </button>
        <button class="btn btn-secondary" @onclick="HandleReprocess" disabled="@_saving">
            Reprocess
        </button>
        <button class="btn btn-danger" @onclick="HandleDismiss" disabled="@_saving">
            Dismiss
        </button>
    </div>
}
else
{
    <!-- Queue List -->
    @if (_loading)
    {
        <div class="loading">Loading review queue...</div>
    }
    else if (_items.Count == 0)
    {
        <div class="card" style="text-align:center;padding:3rem;">
            <div style="font-size:2rem;margin-bottom:0.5rem;">&#x2705;</div>
            <div class="text-muted">Review queue is empty — all emails processed successfully!</div>
        </div>
    }
    else
    {
        <div class="card" style="padding:0;overflow:hidden;">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>From</th>
                        <th>Subject</th>
                        <th>Received</th>
                        <th>Classification</th>
                        <th>Confidence</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in _items)
                    {
                        <tr class="clickable-row" @onclick="() => SelectItem(item)">
                            <td>@(item.FromDisplayName ?? item.FromAddress)</td>
                            <td class="font-semibold">@Truncate(item.Subject, 60)</td>
                            <td>@item.ReceivedAt.ToString("MMM d")</td>
                            <td>
                                <span class="badge badge-blue">@FormatClassification(item.ClassificationType)</span>
                            </td>
                            <td>
                                @if (item.ClassificationConfidence.HasValue)
                                {
                                    var pct = item.ClassificationConfidence.Value * 100;
                                    <span class="@(pct < 70 ? "text-danger" : "")">@pct.ToString("F0")%</span>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>
                            <td>
                                <span class="badge @GetStatusBadgeClass(item.ProcessingStatus)">
                                    @FormatStatus(item.ProcessingStatus)
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (_pagination is not null && _pagination.TotalPages > 1)
        {
            <div class="pagination">
                <button class="btn btn-secondary btn-sm" disabled="@(_page <= 1)" @onclick="PrevPage">Prev</button>
                <span class="text-muted">Page @_page of @_pagination.TotalPages</span>
                <button class="btn btn-secondary btn-sm" disabled="@(_page >= _pagination.TotalPages)" @onclick="NextPage">Next</button>
            </div>
        }
    }
}

<style>
    .review-header {
        display: flex; flex-direction: column; gap: 0.35rem;
        padding: 1rem 1.25rem; border: 1px solid var(--border);
        border-radius: 12px; margin-bottom: 1rem; background: var(--bg-surface);
    }
    .review-error {
        margin-top: 0.5rem; padding: 0.5rem 0.75rem;
        background: #fee2e2; color: var(--red); border-radius: 8px; font-size: 0.85rem;
    }
    .review-split { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
    .review-panel {
        border: 1px solid var(--border); border-radius: 12px;
        overflow: hidden; display: flex; flex-direction: column;
    }
    .review-panel-title {
        font-size: 0.85rem; font-weight: 600; text-transform: uppercase;
        letter-spacing: 0.05em; padding: 0.75rem 1rem;
        background: var(--bg-surface); border-bottom: 1px solid var(--border);
        margin: 0;
    }
    .review-panel-body { padding: 1rem; flex: 1; overflow-y: auto; max-height: 500px; }
    .email-frame { width: 100%; min-height: 400px; border: none; }
    .review-field { margin-bottom: 0.75rem; }
    .review-field label {
        display: block; font-size: 0.75rem; font-weight: 600;
        color: var(--text-secondary); margin-bottom: 0.25rem; text-transform: uppercase;
    }
    .review-field input, .review-field select {
        width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border);
        border-radius: 8px; font-size: 0.9rem; background: #fff;
    }
    .review-actions {
        display: flex; gap: 0.75rem; padding: 1rem 0;
    }
    .raw-json {
        font-size: 0.75rem; background: #f8f9fa; padding: 0.75rem;
        border-radius: 8px; overflow-x: auto; max-height: 200px;
        white-space: pre-wrap; word-break: break-word;
    }
    .text-danger { color: var(--red); font-weight: 600; }
    .btn-danger { background: var(--red); color: #fff; border: none; padding: 0.5rem 1.25rem; border-radius: 8px; cursor: pointer; }
    .btn-danger:hover { opacity: 0.9; }
    .badge-blue { background: #dbeafe; color: #1d4ed8; }
    .badge-yellow { background: #fef3c7; color: #b45309; }
    .badge-red { background: #fee2e2; color: var(--red); }
    .clickable-row { cursor: pointer; }
    .clickable-row:hover { background: #f8f9fa; }
</style>

@code {
    [Inject] private ReviewService ReviewSvc { get; set; } = default!;

    private List<ReviewQueueItem> _items = new();
    private PaginationMeta? _pagination;
    private bool _loading = true;
    private int _page = 1;

    // Detail view
    private ReviewQueueItem? _selectedItem;
    private ReviewDetail? _detail;
    private ReviewCorrection _corrections = new();
    private bool _saving;

    private static readonly string[] _classificationTypes = new[]
    {
        "OrderConfirmation", "OrderModification", "OrderCancellation",
        "PaymentConfirmation", "ShipmentConfirmation", "ShipmentUpdate",
        "DeliveryConfirmation", "DeliveryIssue", "ReturnInitiation",
        "ReturnLabel", "ReturnReceived", "ReturnRejection",
        "RefundConfirmation", "Promotional"
    };

    protected override async Task OnInitializedAsync() => await LoadQueue();

    private async Task LoadQueue()
    {
        _loading = true;
        try
        {
            var (items, pagination) = await ReviewSvc.GetQueueAsync(_page);
            _items = items;
            _pagination = pagination;
        }
        catch { _items = new(); }
        finally { _loading = false; }
    }

    private async Task SelectItem(ReviewQueueItem item)
    {
        _selectedItem = item;
        _corrections = new();
        try { _detail = await ReviewSvc.GetDetailAsync(item.EmailMessageId); }
        catch { _detail = null; }
    }

    private void CloseDetail()
    {
        _selectedItem = null;
        _detail = null;
    }

    private async Task HandleApprove()
    {
        if (_detail is null) return;
        _saving = true;
        try
        {
            await ReviewSvc.ApproveAsync(_detail.EmailMessageId, _corrections);
            _selectedItem = null; _detail = null;
            await LoadQueue();
        }
        finally { _saving = false; }
    }

    private async Task HandleReprocess()
    {
        if (_detail is null) return;
        _saving = true;
        try
        {
            await ReviewSvc.ReprocessAsync(_detail.EmailMessageId);
            _selectedItem = null; _detail = null;
            await LoadQueue();
        }
        finally { _saving = false; }
    }

    private async Task HandleDismiss()
    {
        if (_detail is null) return;
        _saving = true;
        try
        {
            await ReviewSvc.DismissAsync(_detail.EmailMessageId);
            _selectedItem = null; _detail = null;
            await LoadQueue();
        }
        finally { _saving = false; }
    }

    private async Task PrevPage() { _page--; await LoadQueue(); }
    private async Task NextPage() { _page++; await LoadQueue(); }

    private static string FormatClassification(string? ct) =>
        string.IsNullOrEmpty(ct) ? "Unknown" : System.Text.RegularExpressions.Regex.Replace(ct, "(?<=[a-z])(?=[A-Z])", " ");

    private static string FormatStatus(string status) => status switch
    {
        "ManualReview" => "Needs Review",
        "Failed" => "Failed",
        _ => status
    };

    private static string GetStatusBadgeClass(string status) => status switch
    {
        "ManualReview" => "badge-yellow",
        "Failed" => "badge-red",
        _ => "badge-blue"
    };

    private static string Truncate(string s, int max) =>
        s.Length <= max ? s : s[..max] + "...";
}
