name: Deploy API

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

# Never cancel an in-progress deployment
concurrency:
  group: deploy-api
  cancel-in-progress: false

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        run: dotnet restore OrderPulse.sln

      - name: Build (warnings as errors)
        run: dotnet build OrderPulse.sln --configuration Release --no-restore /p:TreatWarningsAsErrors=true

      - name: Test
        run: dotnet test OrderPulse.sln --configuration Release --no-build --verbosity normal

      - name: Publish API
        run: dotnet publish OrderPulse.Api/OrderPulse.Api.csproj --configuration Release --no-build --output ./publish/api

      # Uses OIDC (workload identity federation) â€” no stored credentials.
      # Prerequisite: configure a federated credential on an Azure AD app registration
      # with issuer https://token.actions.githubusercontent.com and subject
      # repo:<owner>/<repo>:ref:refs/heads/main.
      #
      # Fallback: to use a publish profile instead, remove the azure/login step,
      # drop the permissions block, and replace the deploy step with:
      #   - uses: azure/webapps-deploy@v3
      #     with:
      #       app-name: app-orderpulse
      #       publish-profile: ${{ secrets.API_PUBLISH_PROFILE }}
      #       package: ./publish/api
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: app-orderpulse
          package: ./publish/api
